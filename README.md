# `node-modules`

> 🧪 An experimental monorepo for `@guardian/*` NPM packages.

This repo contains a number of pre-configured workflows that make it easier to develop and update packages in accordance with [the Guardian's recommendations](https://github.com/guardian/recommendations/blob/main/npm-packages.md).

<details>
<summary>Show workflows</summary>

-   [x] Node version management
-   [x] NPM package management
-   [x] TypeScript configuration
-   [x] Eslint configuration
-   [x] Testing (using [Jest](https://jestjs.io/))
-   [x] Bundling (using `@guardian/pkgu` – a member of this project)
-   [ ] Versioning (using [changesets](https://github.com/atlassian/changesets))
-   [ ] Publishing (using [changesets](https://github.com/atlassian/changesets))
-   [x] Package config validation
</details>

## Packages

The following packages live in `./packages`:

<!-- START PACKAGES -->
<!-- THIS LIST IS AUTOGENERATED BY scripts/manage-repo/update-readme/list-packages.js -->

-   [`@guardian/editorconfig`](https://github.com/guardian/node-modules/tree/main/packages/editorconfig)
    -   A standard `.editorconfig` for the Guardian.
-   [`@guardian/foo`](https://github.com/guardian/node-modules/tree/main/packages/foo)
    -   A simple test module.
-   [`@guardian/foo-react`](https://github.com/guardian/node-modules/tree/main/packages/foo-react)
    -   A simple test module with react.
-   [`@guardian/pkgu`](https://github.com/guardian/node-modules/tree/main/packages/pkgu)
    -   Automatically build `@guardian` packages for publishing to NPM in line with our recommendations.

<!-- END PACKAGES -->

## Adding a package

🚧 _It's not ready for new packages yet, but when it is..._

Packages only need to worry about what they do – everything else is managed by the project.

> 1. Create a directory in `./packages`
> 1. Add a `package.json`, `README.md` and `src/index.ts`
> 1. Run `make verify-packages`
>
> You now have a minimal but verifiable, publishable package.

## Development

#### _tl;dr_

1. Clone the repo
1. Run `make dev`, or
1. Run `make help` to see what else you can do

### Details

#### `npm-scripts`

Key project tasks (`build`, `test` etc) are defined in the [`npm-scripts`](https://docs.npmjs.com/misc/scripts) of the root `package.json`.

These are mainly for CI or advanced use. Feel free to run them directly if you prefer, but the `makefile` (below) is intended to day-to-day development work.

#### `makefile`

Human-optimised project tasks are defined in the [`makefile`](./Makefile).

These are the `npm-scripts` wrapped in unobtrusive admin tasks that overcome common dev gotchas (correct Node version, up-to-date deps etc).

> 🧑‍💻 If it helps, think of the `makefile` tasks like GitHub Actions for people.

#### Running `makefile` tasks

Run them from the terminal using `make`. Here are some common examples:

<!-- START MAKE TASKS -->
<!-- THIS LIST IS AUTOGENERATED BY scripts/manage-repo/update-readme/list-make-tasks.js -->

-   `make build` build all packages
-   `make bump` bump all updated packages
-   `make changeset` create a new changeset
-   `make clean` delete all dist directories
-   `make dev` run the test suite in watch mode
-   `make fix` try to fix eslint errors
-   `make help` list available commands
-   `make install` install everything you need to run the project
-   `make lint` run eslint over all source code
-   `make manage-repo` keep repo config up-to-date
-   `make release` publish all updated packages
-   `make test` run all tests
-   `make tsc` check all typescript compiles
-   `make validate` run tests, eslint and tsc
-   `make verify-packages` verify all packages are setup correctly

<!-- END MAKE TASKS -->

_Run `make help` to see the full list of commands._

#### Project requirements

Node version, package manager, NPM dependencies etc are automatically managed by the `make` tasks – you can use any `make` command without worrying about them.

_You'll be prompted if you need to install anything._

### Advanced

Behind the scenes, the project is a [pnpm workspace](https://pnpm.io/workspaces).

If you need to do more than the tasks defined in the `makefile` – for example, adding a dependency to your package or managing CI – you should use `pnpm` directly.

See [the pnpm docs](https://pnpm.io) for full information.

## Releasing

Versioning and releasing of updated packages is managed with [changesets](https://github.com/atlassian/changesets).

Make sure you understand [how changesets work](https://github.com/atlassian/changesets/blob/main/docs/detailed-explanation.md) before starting a new release.

```bash
# generate a new changeset
$ make changeset

# version-bump updated packages
$ make bump

# push the new versions to NPM
$ make release
```
